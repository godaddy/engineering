<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="782px" preserveAspectRatio="none" style="width:585px;height:782px;" version="1.1" viewBox="0 0 585 782" width="585px" zoomAndPan="magnify"><defs/><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="35" x2="35" y1="65.29" y2="589.9341"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="158.5" x2="158.5" y1="65.29" y2="589.9341"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="420" x2="420" y1="65.29" y2="589.9341"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="497" x2="497" y1="65.29" y2="589.9341"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="561" x2="561" y1="65.29" y2="589.9341"/><rect fill="#FEFECE" height="30.29" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="34"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="54.3027">Caller</text><rect fill="#FEFECE" height="30.29" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="588.9341"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="609.2368">Caller</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="127.5" y="62.3027">Asherah</text><path d="M138.5,21 L138.5,45 M138.5,33 L155.5,33 " fill="none" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="167.5" cy="33" fill="#FEFECE" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="127.5" y="602.2368">Asherah</text><path d="M138.5,609.2241 L138.5,633.2241 M138.5,621.2241 L155.5,621.2241 " fill="none" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="167.5" cy="621.2241" fill="#FEFECE" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" height="30.29" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="394" y="30"/><rect fill="#FEFECE" height="30.29" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="390" y="34"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="397" y="54.3027">Cache</text><rect fill="#FEFECE" height="30.29" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="394" y="588.9341"/><rect fill="#FEFECE" height="30.29" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="390" y="592.9341"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="397" y="613.2368">Cache</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="460" y="62.3027">Metastore</text><path d="M479,13 C479,3 497,3 497,3 C497,3 515,3 515,13 L515,39 C515,49 497,49 497,49 C497,49 479,49 479,39 L479,13 " fill="#FEFECE" style="stroke: #000000; stroke-width: 1.5;"/><path d="M479,13 C479,23 497,23 497,23 C497,23 515,23 515,13 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="460" y="602.2368">Metastore</text><path d="M479,615.2241 C479,605.2241 497,605.2241 497,605.2241 C497,605.2241 515,605.2241 515,615.2241 L515,641.2241 C515,651.2241 497,651.2241 497,651.2241 C497,651.2241 479,651.2241 479,641.2241 L479,615.2241 " fill="#FEFECE" style="stroke: #000000; stroke-width: 1.5;"/><path d="M479,615.2241 C479,625.2241 497,625.2241 497,625.2241 C497,625.2241 515,625.2241 515,615.2241 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="544" y="62.3027">KMS</text><ellipse cx="561.5" cy="33" fill="#FEFECE" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="549.5" x2="573.5" y1="47" y2="47"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="544" y="602.2368">KMS</text><ellipse cx="561.5" cy="621.2241" fill="#FEFECE" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="549.5" x2="573.5" y1="635.2241" y2="635.2241"/><polygon fill="#A80036" points="147,92.4165,157,96.4165,147,100.4165,151,96.4165" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="35" x2="153" y1="96.4165" y2="96.4165"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="42" y="91.6426">encrypt payload</text><polygon fill="#A80036" points="549.5,121.543,559.5,125.543,549.5,129.543,553.5,125.543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="555.5" y1="125.543" y2="125.543"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="166" y="120.769">generate data key using MK</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="201" y1="179.6694" y2="179.6694"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="201" x2="201" y1="179.6694" y2="192.6694"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="160" x2="201" y1="192.6694" y2="192.6694"/><polygon fill="#A80036" points="170,188.6694,160,192.6694,170,196.6694,166,192.6694" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="166" y="174.8955">generate SK and encrypt using data key</text><polygon fill="#A80036" points="485,217.7959,495,221.7959,485,225.7959,489,221.7959" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="491" y1="221.7959" y2="221.7959"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="166" y="217.022">persist encrypted SK</text><polygon fill="#A80036" points="408,246.9224,418,250.9224,408,254.9224,412,250.9224" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="414" y1="250.9224" y2="250.9224"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="166" y="246.1484">cache SK in protected memory</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="201" y1="305.0488" y2="305.0488"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="201" x2="201" y1="305.0488" y2="318.0488"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="160" x2="201" y1="318.0488" y2="318.0488"/><polygon fill="#A80036" points="170,314.0488,160,318.0488,170,322.0488,166,318.0488" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="166" y="300.2749">generate IK and encrypt using SK</text><polygon fill="#A80036" points="485,343.1753,495,347.1753,485,351.1753,489,347.1753" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="491" y1="347.1753" y2="347.1753"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="166" y="342.4014">persist encrypted IK</text><polygon fill="#A80036" points="408,372.3018,418,376.3018,408,380.3018,412,376.3018" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="414" y1="376.3018" y2="376.3018"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="166" y="371.5278">cache IK in protected memory</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="201" y1="430.4282" y2="430.4282"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="201" x2="201" y1="430.4282" y2="443.4282"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="160" x2="201" y1="443.4282" y2="443.4282"/><polygon fill="#A80036" points="170,439.4282,160,443.4282,170,447.4282,166,443.4282" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="166" y="425.6543">generate DRK and encrypt using IK</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="201" y1="472.5547" y2="472.5547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="201" x2="201" y1="472.5547" y2="485.5547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="160" x2="201" y1="485.5547" y2="485.5547"/><polygon fill="#A80036" points="170,481.5547,160,485.5547,170,489.5547,166,485.5547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="166" y="467.7808">use DRK to encrypt payload</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="201" y1="529.8076" y2="529.8076"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="201" x2="201" y1="529.8076" y2="542.8076"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="160" x2="201" y1="542.8076" y2="542.8076"/><polygon fill="#A80036" points="170,538.8076,160,542.8076,170,546.8076,166,542.8076" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="166" y="509.9072">package encrypted payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="166" y="525.0337">with encrypted DRK in a DRR</text><polygon fill="#A80036" points="46,567.9341,36,571.9341,46,575.9341,42,571.9341" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="40" x2="158" y1="571.9341" y2="571.9341"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="52" y="567.1602">return DRR</text><rect fill="#DDDDDD" height="111.7402" rx="5" ry="5" style="stroke: #000000; stroke-width: 1.0;" width="301" x="11" y="660.2241"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="35" x="22" y="680.561">Type</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="67" y="680.561">Description</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="21" x="21" y="696.8169">MK</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="208" x="66" y="696.8169">Master Key, root key from KMS</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="17" x="21" y="713.1069">SK</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="197" x="66" y="713.1069">System Key, encrypted by MK</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="13" x="21" y="729.397">IK</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="232" x="66" y="729.397">Intermediate Key, encrypted by SK</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="28" x="21" y="745.687">DRK</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="205" x="66" y="745.687">Data Row Key, encrypted by IK</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="28" x="21" y="761.9771">DRR</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="236" x="66" y="761.9771">encrypted data and encrypted DRK</text><line style="stroke: #000000; stroke-width: 1.0;" x1="17" x2="306" y1="667.2241" y2="667.2241"/><line style="stroke: #000000; stroke-width: 1.0;" x1="17" x2="306" y1="683.5142" y2="683.5142"/><line style="stroke: #000000; stroke-width: 1.0;" x1="17" x2="306" y1="699.8042" y2="699.8042"/><line style="stroke: #000000; stroke-width: 1.0;" x1="17" x2="306" y1="716.0942" y2="716.0942"/><line style="stroke: #000000; stroke-width: 1.0;" x1="17" x2="306" y1="732.3843" y2="732.3843"/><line style="stroke: #000000; stroke-width: 1.0;" x1="17" x2="306" y1="748.6743" y2="748.6743"/><line style="stroke: #000000; stroke-width: 1.0;" x1="17" x2="306" y1="764.9644" y2="764.9644"/><line style="stroke: #000000; stroke-width: 1.0;" x1="17" x2="17" y1="667.2241" y2="764.9644"/><line style="stroke: #000000; stroke-width: 1.0;" x1="62" x2="62" y1="667.2241" y2="764.9644"/><line style="stroke: #000000; stroke-width: 1.0;" x1="306" x2="306" y1="667.2241" y2="764.9644"/><!--
@startuml

skinparam shadowing false

legend left
|= Type |= Description |
| MK | Master Key, root key from KMS |
| SK | System Key, encrypted by MK |
| IK | Intermediate Key, encrypted by SK |
| DRK | Data Row Key, encrypted by IK |
| DRR | encrypted data and encrypted DRK |
endlegend

participant Caller
boundary Asherah
collections Cache
database Metastore
entity KMS

Caller -> Asherah : encrypt payload
Asherah -> KMS : generate data key using MK
|||
Asherah -> Asherah : generate SK and encrypt using data key
Asherah -> Metastore : persist encrypted SK
Asherah -> Cache : cache SK in protected memory
|||
Asherah -> Asherah : generate IK and encrypt using SK
Asherah -> Metastore : persist encrypted IK
Asherah -> Cache : cache IK in protected memory
|||
Asherah -> Asherah : generate DRK and encrypt using IK
Asherah -> Asherah : use DRK to encrypt payload
Asherah -> Asherah : package encrypted payload \nwith encrypted DRK in a DRR
Asherah -> Caller : return DRR

@enduml

PlantUML version 1.2018.05(Sat May 05 20:00:17 GMT 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_161-b12
Operating System: Linux
OS Version: 4.9.125-linuxkit
Default Encoding: ANSI_X3.4-1968
Language: en
Country: US
--></g></svg>